<script>

const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTpBCDFzrA3FFkJTGY6BOcRy1cytiKOy30P7iLrRF5F4rs4BTu0ZQNkEaOskOJhz55yL06hlUVOPiro/pub?gid=794880848&single=true&output=csv";

const nf = new Intl.NumberFormat("es-AR");
const pf = new Intl.NumberFormat("es-AR", {style:"percent", minimumFractionDigits:1});

function detectSeparator(line){
  if(line.includes(";")) return ";";
  return ",";
}

function parseCSV(text){
  const lines = text.trim().split("\n");
  const sep = detectSeparator(lines[0]);
  return lines.map(l => l.split(sep));
}

function cleanNumber(val){
  if(!val) return 0;
  return parseFloat(
    val
      .replace(/\./g,"")      // elimina miles
      .replace(",",".")       // convierte decimal
  );
}

async function load(){
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const rows = parseCSV(text);

  const data = [];

  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(!r[0]) continue;

    const tank = r[0];
    const cap = cleanNumber(r[1]);
    const product = r[2];
    const stock = cleanNumber(r[3]);
    const density = cleanNumber(r[4]);
    const util = cleanNumber(r[8]);

    if(!cap || !density) continue;

    const capacityKg = cap * density * 1000;
    const availableKg = capacityKg - stock;

    data.push({
      tank,
      cap,
      product,
      stock,
      density,
      util,
      availableKg
    });
  }

  data.sort((a,b)=>b.util-a.util);

  renderKPIs(data);
  renderTable(data);
  renderRanking(data);
}

function renderKPIs(data){
  const capTotal = data.reduce((s,r)=>s+r.cap,0);
  const stockTotal = data.reduce((s,r)=>s+r.stock,0);
  const volumeTotal = data.reduce((s,r)=>s + (r.stock/(r.density*1000)),0);
  const utilGlobal = stockTotal / data.reduce((s,r)=>s+(r.cap*r.density*1000),0);

  document.getElementById("kpis").innerHTML = `
    <div class="card"><div>Capacidad total (m³)</div><div class="value">${nf.format(capTotal)}</div></div>
    <div class="card"><div>Volumen ocupado (m³)</div><div class="value">${nf.format(volumeTotal)}</div></div>
    <div class="card"><div>Stock total (kg)</div><div class="value">${nf.format(stockTotal)}</div></div>
    <div class="card"><div>Ocupación global</div><div class="value">${pf.format(utilGlobal)}</div></div>
  `;
}

function renderTable(data){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  data.forEach(r=>{
    const width = Math.min(r.util*100,100);
    let cls="warn";
    if(r.util>0.85) cls="bad";
    if(r.util<0.40) cls="good";

    tbody.innerHTML += `
      <tr>
        <td>${r.tank}</td>
        <td>${r.product}</td>
        <td class="right">${nf.format(r.stock)}</td>
        <td class="right">${nf.format(r.availableKg)}</td>
        <td class="right">${pf.format(r.util)}</td>
        <td><div class="bar"><i class="${cls}" style="width:${width}%"></i></div></td>
      </tr>
    `;
  });
}

function renderRanking(data){
  const div = document.getElementById("ranking");
  div.innerHTML = "";

  data.slice(0,8).forEach((r,i)=>{
    div.innerHTML += `
      <div class="rank-item">
        <b>${i+1}. Tank ${r.tank}</b> – ${pf.format(r.util)} – ${nf.format(r.stock)} kg
      </div>
    `;
  });
}

load();

</script>
</body>
</html>
