<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carboclor Tank Dashboard</title>

<style>
body{
margin:0;
background:#0b1020;
color:white;
font-family:system-ui;
}

.wrap{
max-width:1200px;
margin:auto;
padding:20px;
}

h1{margin-bottom:10px}

.cards{
display:grid;
grid-template-columns:repeat(4,1fr);
gap:12px;
margin-bottom:20px;
}

.card{
background:#121b35;
padding:15px;
border-radius:10px;
}

.value{
font-size:24px;
font-weight:bold;
}

table{
width:100%;
border-collapse:collapse;
background:#121b35;
border-radius:10px;
overflow:hidden;
}

th,td{
padding:10px;
border-bottom:1px solid #1f2a4a;
}

.right{text-align:right}

.bar{
height:10px;
background:#1f2a4a;
border-radius:10px;
overflow:hidden;
}

.bar i{
display:block;
height:100%;
}

.good{background:#22c55e}
.warn{background:#f59e0b}
.bad{background:#ef4444}

.status{
margin-top:10px;
color:#9fb0da;
font-size:12px;
}
</style>
</head>

<body>

<div class="wrap">

<h1>Carboclor Tank Status</h1>

<div class="cards" id="kpis"></div>

<table>
<thead>
<tr>
<th>Tank</th>
<th>Product</th>
<th class="right">Stock (kg)</th>
<th class="right">Available (kg)</th>
<th class="right">Util %</th>
<th>Status</th>
</tr>
</thead>
<tbody id="table"></tbody>
</table>

<div class="status" id="status"></div>

</div>

<script>

const CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vSdyOrnlQBDihM-vR3ylD5hyWkwahrugTXpi_tEeEwRxXZiNIEGlZ2VMZvwJ3gkzxHF2XNcFXMQApun/pub?gid=1349722585&single=true&output=csv";

const nf = new Intl.NumberFormat("es-AR");
const pf = new Intl.NumberFormat("es-AR",{style:"percent",minimumFractionDigits:1});

function parseCSV(text){
  return text.trim().split("\n").map(r=>r.split(","));
}

async function load(){

  const res = await fetch(CSV_URL+"?t="+Date.now());
  const text = await res.text();
  const rows = parseCSV(text);

  const data=[];

  for(let i=1;i<rows.length;i++){

    const r=rows[i];
    if(!r[0]) continue;

    data.push({
      tank:r[0],
      cap:parseFloat(r[1]),
      stock:parseFloat(r[2]),
      density:parseFloat(r[3]),
      capacityKg:parseFloat(r[4]),
      availableKg:parseFloat(r[5]),
      util:parseFloat(r[6]),
      volume:parseFloat(r[7]),
      product:r[8]
    });
  }

  data.sort((a,b)=>b.util-a.util);

  render(data);

  document.getElementById("status").innerText =
    "LIVE · Updated "+new Date().toLocaleTimeString();
}

function render(data){

  const capTotal = data.reduce((s,r)=>s+r.cap,0);
  const volTotal = data.reduce((s,r)=>s+r.volume,0);
  const stockTotal = data.reduce((s,r)=>s+r.stock,0);
  const capacityKgTotal = data.reduce((s,r)=>s+r.capacityKg,0);

  const utilGlobal = stockTotal/capacityKgTotal;

  document.getElementById("kpis").innerHTML=`
  <div class="card"><div>Total Capacity m³</div><div class="value">${nf.format(capTotal)}</div></div>
  <div class="card"><div>Used Volume m³</div><div class="value">${nf.format(volTotal)}</div></div>
  <div class="card"><div>Total Stock kg</div><div class="value">${nf.format(stockTotal)}</div></div>
  <div class="card"><div>Global Utilization</div><div class="value">${pf.format(utilGlobal)}</div></div>
  `;

  const tbody=document.getElementById("table");
  tbody.innerHTML="";

  data.forEach(r=>{

    let cls="good";
    if(r.util>0.85) cls="bad";
    else if(r.util>0.60) cls="warn";

    tbody.innerHTML+=`
    <tr>
      <td>${r.tank}</td>
      <td>${r.product}</td>
      <td class="right">${nf.format(r.stock)}</td>
      <td class="right">${nf.format(r.availableKg)}</td>
      <td class="right">${pf.format(r.util)}</td>
      <td>
        <div class="bar">
          <i class="${cls}" style="width:${Math.min(r.util*100,100)}%"></i>
        </div>
      </td>
    </tr>`;
  });
}

load();
setInterval(load,30000);

</script>

</body>
</html>
