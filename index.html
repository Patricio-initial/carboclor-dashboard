<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Tanques — Stock & % Ocupación</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --muted:#9fb0d0;
      --text:#e9f0ff;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% 0%, rgba(46,74,170,.28), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(23,164,184,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position: sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,16,32,.92), rgba(11,16,32,.65));
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 16px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    h1{font-size:18px;margin:0;letter-spacing:.2px}
    .meta{display:flex; gap:10px; align-items:center; flex-wrap:wrap; color:var(--muted); font-size:12px}
    .pill{
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.03);
    }
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    button{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease;
      font-weight:600;
      font-size:13px;
    }
    button:hover{background:rgba(255,255,255,.08)}
    button:active{transform: translateY(1px)}
    select,input{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-size:13px;
      outline:none;
    }
    main .wrap{padding-top:16px}
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .card{
      grid-column: span 6;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    @media (max-width: 920px){ .card{grid-column: span 12;} }
    .card-head{
      padding:14px 14px 10px;
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.02);
    }
    .tank{
      display:flex; flex-direction:column; gap:4px;
    }
    .tank strong{font-size:16px; letter-spacing:.2px}
    .tank small{color:var(--muted); font-size:12px}
    .status{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .card-body{padding:12px 14px 14px;}
    .row{
      display:flex; gap:12px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .kpi{
      flex: 1 1 180px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.12);
    }
    .kpi .label{font-size:11px;color:var(--muted);margin-bottom:6px}
    .kpi .value{font-size:15px;font-weight:700}
    .bar-wrap{margin-top:8px}
    .bar{
      height:12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      border-radius:999px;
      transition: width .4s ease;
      background: linear-gradient(90deg, rgba(52,211,153,.95), rgba(245,158,11,.95), rgba(239,68,68,.95));
    }
    .bar-legend{
      display:flex; justify-content:space-between; margin-top:6px; font-size:11px; color:var(--muted);
    }
    .table{
      margin-top:16px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
    }
    table{width:100%; border-collapse:collapse; font-size:13px}
    thead th{
      text-align:left;
      padding:12px 12px;
      color:var(--muted);
      font-weight:700;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--line);
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      vertical-align:middle;
    }
    tbody tr:hover{background: rgba(255,255,255,.03)}
    .pct{
      display:flex; align-items:center; gap:10px;
      min-width:180px;
    }
    .mini{
      flex:1;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .mini > div{height:100%; width:0%; border-radius:999px}
    .muted{color:var(--muted)}
    .error{
      margin-top:12px;
      padding:12px 14px;
      border:1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      border-radius: 14px;
      color:#ffd6d6;
      display:none;
    }
    .loading{
      opacity:.8;
      font-size:12px;
      color:var(--muted);
    }
    .foot{
      padding:18px 16px;
      color:var(--muted);
      font-size:12px;
      border-top:1px solid var(--line);
      margin-top:18px;
    }
    .right{display:flex; gap:10px; align-items:center}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Dashboard Tanques — Stock, Capacidad y % Ocupación</h1>
        <div class="meta">
          <span class="pill">Fuente: Google Sheets (CSV publicado)</span>
          <span class="pill" id="lastUpdated">Última actualización: —</span>
          <span class="pill loading" id="loading">Cargando…</span>
        </div>
      </div>

      <div class="actions">
        <input id="search" type="search" placeholder="Filtrar (tanque / proveedor / producto)…" />
        <select id="sort">
          <option value="pct_desc">% usado ↓</option>
          <option value="pct_asc">% usado ↑</option>
          <option value="tank_asc">Tanque ↑</option>
          <option value="tank_desc">Tanque ↓</option>
          <option value="kg_desc">Stock kg ↓</option>
          <option value="kg_asc">Stock kg ↑</option>
        </select>
        <button id="refreshBtn">Refrescar</button>
      </div>
    </div>

    <div class="error" id="errorBox"></div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="grid" id="cards"></div>

    <div class="table" aria-label="Tabla resumen">
      <table>
        <thead>
          <tr>
            <th>Tanque</th>
            <th>Proveedor / Producto</th>
            <th>Stock actual (kg)</th>
            <th>Capacidad (kg)</th>
            <th>% usado</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="foot">
      <div>Auto-refresh cada 5 minutos (y también al apretar “Refrescar”).</div>
      <div class="muted">Tip: si el CSV tarda en reflejar cambios, suele ser por cache del endpoint; este dashboard agrega un parámetro anti-cache automáticamente.</div>
    </div>
  </div>
</main>

<script>
  // === CONFIG ===
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSdyOrnlQBDihM-vR3ylD5hyWkwahrugTXpi_tEeEwRxXZiNIEGlZ2VMZvwJ3gkzxHF2XNcFXMQApun/pub?gid=1509369466&single=true&output=csv";
  const AUTO_REFRESH_MS = 5 * 60 * 1000;

  // === HELPERS ===
  const $ = (id) => document.getElementById(id);

  function formatNumber(n){
    if (n === null || n === undefined || Number.isNaN(n)) return "—";
    return new Intl.NumberFormat("es-AR").format(n);
  }

  function parsePercent(value){
    if (value === null || value === undefined) return null;
    const s = String(value).trim().replace(",", ".");
    const num = parseFloat(s.replace("%",""));
    return Number.isFinite(num) ? num : null;
  }

  function parseKg(value){
    if (value === null || value === undefined) return null;
    // handles "234,233.00" and "234.233,00" style mixes by:
    // 1) remove spaces
    // 2) if contains both '.' and ',' assume ',' thousands? We'll normalize:
    // We'll keep it pragmatic for your sheet: "234,233.00" (comma thousands, dot decimals)
    let s = String(value).trim().replace(/\s/g,'');
    // Remove thousands separators in either style:
    // If looks like 234,233.00 -> remove commas
    if (/^\d{1,3}(,\d{3})+(\.\d+)?$/.test(s)) s = s.replace(/,/g,'');
    // If looks like 234.233,00 -> remove dots, turn comma to dot
    if (/^\d{1,3}(\.\d{3})+(,\d+)?$/.test(s)) s = s.replace(/\./g,'').replace(/,/g,'.');
    // If only comma decimals:
    if (/^\d+(,\d+)$/.test(s)) s = s.replace(/,/g,'.');
    const num = parseFloat(s);
    return Number.isFinite(num) ? num : null;
  }

  // Minimal CSV parser supporting quoted commas/newlines
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i=0; i<text.length; i++){
      const ch = text[i];
      const next = text[i+1];

      if (ch === '"' ){
        if (inQuotes && next === '"'){ // escaped quote
          cur += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
        continue;
      }

      if (!inQuotes && ch === ','){
        row.push(cur);
        cur = "";
        continue;
      }

      if (!inQuotes && (ch === '\n' || ch === '\r')){
        if (ch === '\r' && next === '\n') i++; // handle CRLF
        row.push(cur);
        cur = "";
        // ignore blank last row
        if (row.length > 1 || (row.length === 1 && row[0].trim() !== "")) rows.push(row);
        row = [];
        continue;
      }

      cur += ch;
    }

    // last cell
    row.push(cur);
    if (row.length > 1 || (row.length === 1 && row[0].trim() !== "")) rows.push(row);

    return rows;
  }

  function normalizeHeaders(headers){
    // map common variants to canonical keys
    const norm = headers.map(h => String(h||"").trim());
    const lower = norm.map(h => h.toLowerCase());

    function idxOfAny(candidates){
      for (const c of candidates){
        const i = lower.indexOf(c.toLowerCase());
        if (i !== -1) return i;
      }
      return -1;
    }

    return {
      tank: idxOfAny(["tank","tanque"]),
      supplier: idxOfAny(["product/supplier","proveedor","producto/proveedor","product","supplier"]),
      stockKg: idxOfAny(["stock_ kg","stocl_ kg","stock kg","stock_kg","stock","kg","kgs"]),
      capKg: idxOfAny(["capacity_kg","capacity kg","capacidad_kg","capacidad kg","capacity"]),
      pct: idxOfAny(["% used","%used","used","ocupacion","% ocupación","% ocupacion"])
    };
  }

  function statusForPct(pct){
    if (pct === null) return {label:"Sin dato", color:"rgba(148,163,184,.9)"};
    if (pct >= 100) return {label:"Full", color:"rgba(168,85,247,.95)"};
    if (pct >= 90)  return {label:"Crítico", color:"rgba(239,68,68,.95)"};
    if (pct >= 70)  return {label:"Alto", color:"rgba(245,158,11,.95)"};
    return {label:"OK", color:"rgba(52,211,153,.95)"};
  }

  function sortData(data, mode){
    const copy = [...data];
    const cmp = {
      pct_desc: (a,b)=> (b.pct??-1) - (a.pct??-1),
      pct_asc:  (a,b)=> (a.pct??1e9) - (b.pct??1e9),
      tank_asc: (a,b)=> String(a.tank).localeCompare(String(b.tank), "es", {numeric:true}),
      tank_desc:(a,b)=> String(b.tank).localeCompare(String(a.tank), "es", {numeric:true}),
      kg_desc:  (a,b)=> (b.stockKg??-1) - (a.stockKg??-1),
      kg_asc:   (a,b)=> (a.stockKg??1e18) - (b.stockKg??1e18)
    }[mode] || ((a,b)=>0);

    copy.sort(cmp);
    return copy;
  }

  function filterData(data, q){
    const s = (q||"").trim().toLowerCase();
    if (!s) return data;
    return data.filter(r => {
      const hay = `${r.tank} ${r.supplier}`.toLowerCase();
      return hay.includes(s);
    });
  }

  // === RENDER ===
  function render(data){
    const cards = $("cards");
    const tbody = $("tbody");
    cards.innerHTML = "";
    tbody.innerHTML = "";

    for (const r of data){
      const st = statusForPct(r.pct);

      // Cards
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="card-head">
          <div class="tank">
            <strong>Tanque ${escapeHtml(r.tank)}</strong>
            <small>${escapeHtml(r.supplier || "—")}</small>
          </div>
          <div class="status" style="border-color: ${st.color}; color:${st.color}">
            ${st.label}${r.pct !== null ? ` · ${r.pct.toFixed(2)}%` : ""}
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="kpi">
              <div class="label">Stock actual</div>
              <div class="value">${formatNumber(r.stockKg)} kg</div>
            </div>
            <div class="kpi">
              <div class="label">Capacidad</div>
              <div class="value">${formatNumber(r.capKg)} kg</div>
            </div>
          </div>

          <div class="bar-wrap">
            <div class="bar" title="${r.pct !== null ? r.pct.toFixed(2) : "—"}%">
              <div style="width:${clampPct(r.pct)}%; background:${st.color}"></div>
            </div>
            <div class="bar-legend">
              <span>0%</span>
              <span class="muted">Ocupación</span>
              <span>100%</span>
            </div>
          </div>
        </div>
      `;
      cards.appendChild(card);

      // Table rows
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><strong>${escapeHtml(r.tank)}</strong></td>
        <td>${escapeHtml(r.supplier || "—")}</td>
        <td>${formatNumber(r.stockKg)}</td>
        <td>${formatNumber(r.capKg)}</td>
        <td>
          <div class="pct">
            <div class="mini" aria-label="Barra % usado">
              <div style="width:${clampPct(r.pct)}%; background:${st.color}"></div>
            </div>
            <span style="color:${st.color}; font-weight:700;">
              ${r.pct !== null ? r.pct.toFixed(2) + "%" : "—"}
            </span>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function clampPct(pct){
    if (pct === null || pct === undefined || !Number.isFinite(pct)) return 0;
    return Math.max(0, Math.min(100, pct));
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // === DATA LOAD ===
  async function load(){
    $("errorBox").style.display = "none";
    $("loading").style.display = "inline-block";

    try{
      const bust = `&_ts=${Date.now()}`; // anti-cache
      const res = await fetch(CSV_URL + bust, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} al traer el CSV`);
      const text = await res.text();

      const rows = parseCSV(text);
      if (!rows.length) throw new Error("CSV vacío o inválido.");

      const headers = rows[0];
      const map = normalizeHeaders(headers);

      if ([map.tank, map.supplier, map.stockKg, map.capKg, map.pct].some(i => i === -1)){
        throw new Error("No pude mapear columnas del CSV. Revisá los headers publicados (Tank, Product/Supplier, Stock_ Kg, Capacity_Kg, % Used).");
      }

      const data = rows.slice(1).map(r => ({
        tank: (r[map.tank] ?? "").trim(),
        supplier: (r[map.supplier] ?? "").trim(),
        stockKg: parseKg(r[map.stockKg]),
        capKg: parseKg(r[map.capKg]),
        pct: parsePercent(r[map.pct])
      })).filter(r => r.tank !== "");

      const q = $("search").value;
      const sorted = sortData(filterData(data, q), $("sort").value);

      render(sorted);

      const now = new Date();
      $("lastUpdated").textContent = `Última actualización: ${now.toLocaleString("es-AR")}`;
    }catch(err){
      const box = $("errorBox");
      box.textContent = `Error cargando datos: ${err.message}`;
      box.style.display = "block";
    }finally{
      $("loading").style.display = "none";
    }
  }

  // === EVENTS ===
  $("refreshBtn").addEventListener("click", load);
  $("sort").addEventListener("change", load);

  let debounce;
  $("search").addEventListener("input", () => {
    clearTimeout(debounce);
    debounce = setTimeout(load, 180);
  });

  // initial + auto refresh
  load();
  setInterval(load, AUTO_REFRESH_MS);
</script>
</body>
</html>
