<!doctype html>
<html lang="es-AR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carboclor – Tank Dashboard</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0f1830;
      --text:#e9eefc;
      --muted:#9fb0da;
      --border:rgba(255,255,255,.08);
      --shadow:0 10px 30px rgba(0,0,0,.35);

      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#1a2750;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 600px at 20% 10%, #182a5c 0%, transparent 55%),
                  radial-gradient(900px 500px at 90% 0%, #2a164f 0%, transparent 55%),
                  var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px 18px 40px}
    header{
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:14px;
    }
    .title h1{margin:0;font-size:20px;letter-spacing:.3px}
    .title .sub{margin-top:6px;color:var(--muted);font-size:13px}
    .actions{display:flex;gap:10px;align-items:center}
    button{
      background: linear-gradient(180deg, #2a3d7a 0%, #223465 100%);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:10px 12px;
      cursor:pointer;
      box-shadow: var(--shadow);
      font-weight:600;
    }
    button:hover{filter:brightness(1.06)}
    .stamp{color:var(--muted);font-size:12px;padding-top:10px}

    .grid{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .cards{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
      margin-bottom:14px;
    }
    @media (max-width: 980px){ .cards{grid-template-columns: repeat(2, 1fr);} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,.03) 100%);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px 14px 12px;
      box-shadow: var(--shadow);
    }
    .card .label{color:var(--muted);font-size:12px}
    .card .value{margin-top:8px;font-size:22px;font-weight:800;letter-spacing:.3px}
    .card .hint{margin-top:6px;color:var(--muted);font-size:12px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;border:1px solid var(--border);
      background: rgba(16,26,51,.7); color:var(--muted); font-size:12px;
    }
    .pill b{color:var(--text)}
    .kpi-badge{
      display:inline-block;margin-left:8px;padding:3px 8px;border-radius:999px;
      font-size:12px;font-weight:800;border:1px solid var(--border);
    }
    .kpi-good{background:rgba(34,197,94,.15);color:#7ef0a8}
    .kpi-warn{background:rgba(245,158,11,.15);color:#ffd18a}
    .kpi-bad{background:rgba(239,68,68,.15);color:#ff9b9b}

    .panel{
      background: rgba(16,26,51,.6);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel h2{
      margin:0;
      padding:12px 14px;
      font-size:13px;
      letter-spacing:.3px;
      color:var(--muted);
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .panel .body{padding:12px 14px}

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:12.5px;
    }
    thead th{
      position:sticky; top:0;
      background: rgba(15,24,48,.95);
      z-index:1;
      text-align:left;
      color:var(--muted);
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      font-weight:700;
      letter-spacing:.2px;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
    }
    tbody tr:hover{background:rgba(255,255,255,.03)}
    .mono{font-variant-numeric: tabular-nums}
    .right{text-align:right}
    .nowrap{white-space:nowrap}
    .product{
      max-width:280px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .bar{
      height:10px;border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.06);
      overflow:hidden;
      min-width:120px;
    }
    .bar > i{
      display:block;height:100%;
      width:0%;
      border-radius:999px;
    }
    .i-good{background: linear-gradient(90deg, rgba(34,197,94,.9), rgba(34,197,94,.55));}
    .i-warn{background: linear-gradient(90deg, rgba(245,158,11,.9), rgba(245,158,11,.55));}
    .i-bad{background: linear-gradient(90deg, rgba(239,68,68,.9), rgba(239,68,68,.55));}

    .rank-item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 10px;border:1px solid rgba(255,255,255,.06);
      border-radius:12px;background: rgba(15,24,48,.65);
      margin-bottom:10px;
    }
    .rank-left{display:flex;gap:10px;align-items:center;min-width:0}
    .rank-num{
      width:26px;height:26px;border-radius:8px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      font-weight:800;
      flex:0 0 auto;
    }
    .rank-tank{font-weight:800}
    .rank-prod{
      color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:180px;
    }

    .status{
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(16,26,51,.55);
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .error{color:#ffb4b4}
    .ok{color:#a7f3d0}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Carboclor – Tank Dashboard</h1>
        <div class="sub">Fuente: Google Sheets (Dashboard_Clean) · Vista operativa (capacidad / ocupación / ranking)</div>
      </div>
      <div class="actions">
        <button id="btnRefresh">Actualizar datos</button>
        <div class="stamp" id="lastUpdated">Última actualización: —</div>
      </div>
    </header>

    <div class="cards" id="kpiCards">
      <!-- KPIs injected -->
    </div>

    <div class="grid">
      <div class="panel">
        <h2>
          <span>Estado por tanque</span>
          <span class="pill"><span>Orden:</span> <b>Mayor ocupación → menor</b></span>
        </h2>
        <div class="body" style="padding:0">
          <div style="overflow:auto; max-height:560px">
            <table id="tankTable">
              <thead>
                <tr>
                  <th class="nowrap">Tank</th>
                  <th>Product</th>
                  <th class="right nowrap">Cap (m³)</th>
                  <th class="right nowrap">Stock (kg)</th>
                  <th class="right nowrap">Vol (m³)</th>
                  <th class="right nowrap">Disp (m³)</th>
                  <th class="right nowrap">Util %</th>
                  <th class="nowrap">Barra</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="body">
            <div class="status" id="statusBox">Cargando datos…</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>
          <span>Ranking (Top)</span>
          <span class="pill">Umbrales: <b>&gt;85%</b> rojo · <b>40–85%</b> ámbar · <b>&lt;40%</b> verde</span>
        </h2>
        <div class="body" id="ranking">
          <!-- Ranking injected -->
        </div>
      </div>
    </div>
  </div>

<script>
  // === CONFIG ===
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTpBCDFzrA3FFkJTGY6BOcRy1cytiKOy30P7iLrRF5F4rs4BTu0ZQNkEaOskOJhz55yL06hlUVOPiro/pub?gid=794880848&single=true&output=csv";

  // Column names expected (case-insensitive)
  const COLS = {
    tank: ["tank", "shore tank", "shore_tank"],
    cap: ["capacity_m3", "capacity m3", "cap m3", "cap_m3"],
    product: ["product", "current product"],
    stock: ["stock_kg", "stock kg", "stock kgs", "stock_kgs"],
    density: ["density_kg_m3", "density", "density kg/m3"],
    volume: ["volume_m3", "volume m3", "vol m3", "vol_m3"],
    available: ["available_m3", "available m3", "disp m3", "available"],
    utilReal: ["utilization_real", "utilization", "utilization pct", "utilization_pct", "% used", "used"]
  };

  const nf0 = new Intl.NumberFormat("es-AR", { maximumFractionDigits: 0 });
  const nf2 = new Intl.NumberFormat("es-AR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const pf1 = new Intl.NumberFormat("es-AR", { style: "percent", minimumFractionDigits: 1, maximumFractionDigits: 1 });

  function utilClass(u){
    if (!isFinite(u)) return "i-warn";
    if (u > 0.85) return "i-bad";
    if (u < 0.40) return "i-good";
    return "i-warn";
  }
  function kpiBadgeClass(u){
    if (!isFinite(u)) return "kpi-warn";
    if (u > 0.85) return "kpi-bad";
    if (u < 0.60) return "kpi-good";
    return "kpi-warn";
  }

  function setStatus(html, kind=""){
    const el = document.getElementById("statusBox");
    el.innerHTML = html;
    el.className = "status " + kind;
  }

  // Robust CSV parser (handles quoted commas)
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i=0; i<text.length; i++){
      const c = text[i];
      if (c === '"'){
        if (inQuotes && text[i+1] === '"'){ // escaped quote
          cur += '"'; i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (c === ',' && !inQuotes){
        row.push(cur); cur = "";
      } else if ((c === '\n' || c === '\r') && !inQuotes){
        if (c === '\r' && text[i+1] === '\n') i++;
        row.push(cur); cur = "";
        // ignore empty last line
        if (row.some(v => (v ?? "").toString().trim() !== "")) rows.push(row);
        row = [];
      } else {
        cur += c;
      }
    }
    // last cell
    row.push(cur);
    if (row.some(v => (v ?? "").toString().trim() !== "")) rows.push(row);
    return rows;
  }

  function normalizeHeader(h){
    return (h ?? "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/\s+/g, " ")
      .replace(/[_\-]+/g, "_");
  }

  function findColIndex(headers, aliases){
    const map = headers.map(normalizeHeader);
    for (const a of aliases){
      const idx = map.indexOf(normalizeHeader(a));
      if (idx !== -1) return idx;
    }
    return -1;
  }

  function toNumberLoose(v){
    // Accept numbers already typed, or strings with AR formatting.
    // Examples:
    // "1.089.647" -> 1089647
    // "0,9204" -> 0.9204
    // "87,09%" -> 0.8709 (if percent) handled elsewhere
    if (v === null || v === undefined) return NaN;
    if (typeof v === "number") return v;
    const s0 = v.toString().trim();
    if (!s0) return NaN;

    // Remove spaces
    let s = s0.replace(/\s+/g, "");
    // If contains % leave it for percent logic
    if (s.includes("%")) s = s.replace("%", "");

    // Heuristic:
    // - If has ',' and '.' assume '.' is thousands and ',' is decimal.
    // - If only '.' assume thousands (common in AR) unless there are 1-3 digits after and no other dots.
    // We'll do safe: remove dots, replace comma with dot (AR -> JS)
    s = s.replace(/\./g, "");
    s = s.replace(/,/g, ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function toPercent(v){
    if (v === null || v === undefined) return NaN;
    if (typeof v === "number"){
      // if already 0-1, keep; if 0-100, convert
      if (v <= 1) return v;
      if (v <= 100) return v / 100;
      return NaN;
    }
    const s = v.toString().trim();
    if (!s) return NaN;
    const hasPct = s.includes("%");
    const n = toNumberLoose(s);
    if (!isFinite(n)) return NaN;
    if (hasPct) return n / 100; // "87,1%" -> 0.871
    // If no %, assume it's already 0-1 unless looks like 0-100
    if (n > 1 && n <= 100) return n / 100;
    return n;
  }

  function formatKg(x){ return isFinite(x) ? nf0.format(x) : "—"; }
  function formatM3(x){ return isFinite(x) ? nf0.format(x) : "—"; }
  function formatM3_2(x){ return isFinite(x) ? nf2.format(x) : "—"; }
  function formatPct(x){ return isFinite(x) ? pf1.format(x) : "—"; }

  function renderKPIs({capTotal, volTotal, availTotal, utilGlobal}){
    const el = document.getElementById("kpiCards");
    const badge = `<span class="kpi-badge ${kpiBadgeClass(utilGlobal)}">${formatPct(utilGlobal)}</span>`;
    el.innerHTML = `
      <div class="card">
        <div class="label">Capacidad total</div>
        <div class="value mono">${formatM3(capTotal)} <span class="label">m³</span></div>
        <div class="hint">Σ Capacity_m3</div>
      </div>
      <div class="card">
        <div class="label">Volumen ocupado</div>
        <div class="value mono">${formatM3_2(volTotal)} <span class="label">m³</span></div>
        <div class="hint">Σ Volume_m3</div>
      </div>
      <div class="card">
        <div class="label">Capacidad disponible</div>
        <div class="value mono">${formatM3_2(availTotal)} <span class="label">m³</span></div>
        <div class="hint">Σ Available_m3</div>
      </div>
      <div class="card">
        <div class="label">Ocupación global (ponderada)</div>
        <div class="value mono">${badge}</div>
        <div class="hint">Σ Volume_m3 / Σ Capacity_m3</div>
      </div>
    `;
  }

  function renderTable(rows){
    const tbody = document.querySelector("#tankTable tbody");
    tbody.innerHTML = "";

    for (const r of rows){
      const u = r.util;
      const barClass = utilClass(u);
      const width = isFinite(u) ? Math.max(0, Math.min(100, u * 100)) : 0;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono nowrap"><b>${r.tank}</b></td>
        <td class="product" title="${escapeHtml(r.product || "")}">${escapeHtml(r.product || "—")}</td>
        <td class="right mono nowrap">${formatM3(r.cap)}</td>
        <td class="right mono nowrap">${formatKg(r.stock)}</td>
        <td class="right mono nowrap">${formatM3_2(r.vol)}</td>
        <td class="right mono nowrap">${formatM3_2(r.avail)}</td>
        <td class="right mono nowrap"><b>${formatPct(u)}</b></td>
        <td class="nowrap">
          <div class="bar" title="${formatPct(u)}">
            <i class="${barClass}" style="width:${width}%;"></i>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderRanking(rows){
    const el = document.getElementById("ranking");
    const top = rows.slice(0, 8); // top 8
    el.innerHTML = top.map((r, i) => {
      const cls = kpiBadgeClass(r.util).replace("kpi-",""); // good/warn/bad
      const badge =
        r.util > 0.85 ? "kpi-bad" : (r.util < 0.40 ? "kpi-good" : "kpi-warn");
      return `
        <div class="rank-item">
          <div class="rank-left" style="min-width:0">
            <div class="rank-num">${i+1}</div>
            <div style="min-width:0">
              <div class="rank-tank mono">Tank ${escapeHtml(r.tank)}</div>
              <div class="rank-prod">${escapeHtml(r.product || "—")}</div>
            </div>
          </div>
          <div class="kpi-badge ${badge} mono">${formatPct(r.util)}</div>
        </div>
      `;
    }).join("");
  }

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function load(){
    setStatus("Cargando datos desde Google Sheets…");
    const t0 = performance.now();

    let text;
    try{
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      text = await res.text();
    } catch (e){
      setStatus(`Error al descargar CSV: <span class="error">${escapeHtml(e.message)}</span><br/>Verificá que el sheet siga publicado como CSV.`, "error");
      return;
    }

    let rows;
    try{
      rows = parseCSV(text);
    } catch (e){
      setStatus(`Error parseando CSV: <span class="error">${escapeHtml(e.message)}</span>`, "error");
      return;
    }

    if (!rows.length || rows.length < 2){
      setStatus(`CSV vacío o sin filas suficientes.`, "error");
      return;
    }

    const headers = rows[0];
    const idxTank = findColIndex(headers, COLS.tank);
    const idxCap = findColIndex(headers, COLS.cap);
    const idxProd = findColIndex(headers, COLS.product);
    const idxStock = findColIndex(headers, COLS.stock);
    const idxVol = findColIndex(headers, COLS.volume);
    const idxAvail = findColIndex(headers, COLS.available);
    const idxUtil = findColIndex(headers, COLS.utilReal);

    const missing = [];
    if (idxTank === -1) missing.push("Tank");
    if (idxCap === -1) missing.push("Capacity_m3");
    if (idxProd === -1) missing.push("Product");
    if (idxStock === -1) missing.push("Stock_kg");
    if (idxVol === -1) missing.push("Volume_m3");
    if (idxAvail === -1) missing.push("Available_m3");
    if (idxUtil === -1) missing.push("Utilization_real");

    if (missing.length){
      setStatus(
        `No encontré columnas requeridas: <span class="error">${missing.join(", ")}</span><br/>
         Headers detectados: <span class="mono">${headers.map(h => escapeHtml(h)).join(" | ")}</span>`,
        "error"
      );
      return;
    }

    const data = [];
    for (let i=1; i<rows.length; i++){
      const r = rows[i];
      const tankRaw = (r[idxTank] ?? "").toString().trim();
      if (!tankRaw) continue;

      const tank = tankRaw; // keep as string
      const cap = toNumberLoose(r[idxCap]);
      const product = (r[idxProd] ?? "").toString().trim();
      const stock = toNumberLoose(r[idxStock]);
      const vol = toNumberLoose(r[idxVol]);
      const avail = toNumberLoose(r[idxAvail]);
      const util = toPercent(r[idxUtil]); // expects 0-1

      // ignore non-numeric tank like "Total" just in case
      if (!/^\d+$/.test(tank)) continue;

      data.push({ tank, cap, product, stock, vol, avail, util });
    }

    // Sort by util desc (highest risk first)
    data.sort((a,b) => (b.util ?? -1) - (a.util ?? -1));

    const capTotal = data.reduce((s,r) => s + (isFinite(r.cap) ? r.cap : 0), 0);
    const volTotal = data.reduce((s,r) => s + (isFinite(r.vol) ? r.vol : 0), 0);
    const availTotal = data.reduce((s,r) => s + (isFinite(r.avail) ? r.avail : 0), 0);
    const utilGlobal = capTotal > 0 ? (volTotal / capTotal) : NaN;

    renderKPIs({capTotal, volTotal, availTotal, utilGlobal});
    renderTable(data);
    renderRanking(data);

    const ms = Math.round(performance.now() - t0);
    setStatus(
      `<span class="ok">OK</span> · ${data.length} tanques · ${ms} ms<br/>
       Fuente: CSV publicado (Dashboard_Clean)`,
      ""
    );

    const now = new Date();
    document.getElementById("lastUpdated").textContent =
      "Última actualización: " + now.toLocaleString("es-AR");
  }

  document.getElementById("btnRefresh").addEventListener("click", load);
  load();
</script>
</body>
</html>
